<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>IP å‚å•†è¯†åˆ«å·¥å…·</title>
    <style>
        /* ------------------------------------------- */
        /* è¿˜åŸç”¨æˆ·æä¾›çš„ CSS æ ·å¼ */
        /* ------------------------------------------- */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #333; margin-top: 25px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        textarea, input[type="text"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; }
        textarea { height: 120px; }
        
        /* é€šç”¨æŒ‰é’®æ ·å¼ - ä»…åº”ç”¨äºè¡¨å•æŒ‰é’®ï¼Œä¸å½±å“å¯¼å‡ºæŒ‰é’® */
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #218838; }
        
        /* --- å¯¼å‡ºæŒ‰é’®çš„ä¸“ç”¨æ ·å¼ --- */
        #exportButton { 
            background-color: #17a2b8; 
            color: white; 
            /* è¦†ç›–é€šç”¨çš„ margin-top: 20px; å¹¶å¢åŠ åº•éƒ¨é—´è· */
            margin-top: 10px; 
            margin-bottom: 20px; 
            padding: 8px 15px; 
            font-size: 14px; 
            width: auto; /* ç¡®ä¿å®ƒä¸ä¼šå æ® 100% å®½åº¦ */
        }
        #exportButton:hover:not(:disabled) { background-color: #117a8b; }
        #exportButton:disabled { background-color: #ccc; cursor: not-allowed; }

        #results { margin-top: 30px; }
        /* ä½¿ç”¨æˆ·æä¾›çš„è¡¨æ ¼æ ·å¼ */
        #results table { width: 100%; border-collapse: collapse; margin-top: 15px;}
        #results th, #results td { padding: 10px; text-align: left; border: 1px solid #ddd; font-size: 14px; }
        #results th { background-color: #007bff; color: white; }
        
        .status-NXDOMAIN, .status-TIMEOUT, .status-ERROR { color: red; font-weight: bold; }
        .status-OK { color: green; font-weight: bold; }
        .loading { text-align: center; margin-top: 20px; font-size: 1.1em; color: #555; }
        .add-vendor-btn { background-color: #ffc107; color: black; border: 1px solid #c09b06; margin-top: 5px;}
        .add-vendor-btn:hover { background-color: #e0a800; }
        #filterControls { background-color: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee; }
        .nav-link { margin-left: 15px; color: #007bff; text-decoration: none; font-weight: bold;}
        .status-message { margin-top: 15px; font-weight: bold; } 

    </style>
</head>
<body>
    <div class="container">
        <div style="float: right; margin-top: -50px;">
            <p>
                å½“å‰ç”¨æˆ·: <strong>{{ current_user.id }}</strong>
                <a href="{{ url_for('vendor_manage_page') }}" class="nav-link">[å‚å•†ç®¡ç†]</a> 
                <a href="{{ url_for('logout') }}" style="color: red; margin-left: 15px;">[ç™»å‡º]</a>
            </p>
        </div>
        
        <h1>ğŸŒ IP å‚å•†è¯†åˆ«å·¥å…·</h1>
        <div style="clear: both;"></div>

        <h2>æŸ¥è¯¢é…ç½®</h2>
        <form id="queryForm">
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="dnsServers">è‡ªå®šä¹‰ DNS æœåŠ¡å™¨ IP (æ¯è¡Œä¸€ä¸ª):</label>
                    <textarea id="dnsServers" rows="4"></textarea> 
                </div>
                <div style="flex: 1;">
                    <label for="domains">åŸŸååˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª):</label>
                    <textarea id="domains" rows="4" placeholder="ä¾‹å¦‚ï¼š&#10;example.com&#10;www.google.com"></textarea>
                </div>
            </div>
            <button type="submit" id="queryButton">æ‰§è¡Œå®æ—¶æŸ¥è¯¢</button>
            <div id="queryStatusMessage" class="status-message"></div>
        </form>

        <hr style="margin: 30px 0;">
        <h2>ğŸ” ç­›é€‰ç»“æœ</h2>
        
        <button id="exportButton" disabled>å¯¼å‡ºå½“å‰ç­›é€‰ç»“æœ (CSV)</button>
        
        <div id="filterControls" style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1;">
                <label for="filterDomain">ç­›é€‰åŸŸå:</label>
                <input type="text" id="filterDomain" placeholder="è¾“å…¥åŸŸåå…³é”®è¯">
            </div>
            <div style="flex: 1;">
                <label for="filterVendor">ç­›é€‰å‚å•†:</label>
                <input type="text" id="filterVendor" placeholder="è¾“å…¥å‚å•†å…³é”®è¯">
            </div>
			<div style="flex: 1;">
                <label for="filterDnsServer">ç­›é€‰ DNS æœåŠ¡å™¨:</label>
                <select id="filterDnsServer">
                    <option value="">-- æ˜¾ç¤ºå…¨éƒ¨ --</option>
                    </select>
            </div>
            <div style="flex: 1;">
                <label for="filterStatus">ç­›é€‰çŠ¶æ€:</label>
                <select id="filterStatus">
                    <option value="">-- æ˜¾ç¤ºå…¨éƒ¨ --</option>
                    <option value="OK">è§£ææˆåŠŸ (OK)</option>
                    <option value="NXDOMAIN">åŸŸåä¸å­˜åœ¨ (NXDOMAIN)</option>
                    <option value="TIMEOUT">è¶…æ—¶ (TIMEOUT)</option>
                    <option value="ERROR">æŸ¥è¯¢é”™è¯¯ (ERROR)</option>
                    </select>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">æ­£åœ¨æŸ¥è¯¢ï¼Œè¯·ç¨å€™...</div>
        <div id="results">
        </div>
    </div>

    <script>
        const DNS_SERVERS_KEY = 'lastUsedDnsServers';
        let LAST_QUERY_RESULTS = []; // å­˜å‚¨åç«¯è¿”å›çš„æ‰å¹³åŒ–ç»“æœ

        // --- æ ¸å¿ƒ AJAX æäº¤å‡½æ•° (ä¿ç•™æ‰€æœ‰é”™è¯¯ä¿®å¤å’Œé€»è¾‘) ---
        function submitForm(url, payload, buttonId, statusMessageId, successCallback) {
            const button = document.getElementById(buttonId);
            const statusDiv = document.getElementById(statusMessageId);
            const originalText = button.innerText;

            statusDiv.style.display = 'block';
            statusDiv.innerText = 'æ­£åœ¨å‘é€è¯·æ±‚...';
            statusDiv.style.color = 'black';
            
            // ä¿æŠ¤æ€§æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
            if (button) {
                button.disabled = true;
                button.innerText = 'å¤„ç†ä¸­...';
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(`HTTP é”™è¯¯ ${response.status}: ${err.message || 'æœªçŸ¥æœåŠ¡å™¨é”™è¯¯'}`);
                    }).catch(() => {
                        throw new Error(`HTTP é”™è¯¯ ${response.status}ã€‚`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.innerText = data.message || `æŸ¥è¯¢æˆåŠŸã€‚`;
                    statusDiv.style.color = 'green';
                    successCallback(data); // æ‰§è¡ŒæˆåŠŸå›è°ƒå‡½æ•°
                } else {
                    statusDiv.innerText = `æœåŠ¡å™¨å¤„ç†å¤±è´¥: ${data.message}`;
                    statusDiv.style.color = 'red';
                }
                if (button) {
                    button.disabled = false;
                    button.innerText = originalText;
                }
            })
            .catch(error => {
                statusDiv.innerText = `ç½‘ç»œæˆ–æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.toString()}`;
                statusDiv.style.color = 'red';
                if (button) {
                    button.disabled = false;
                    button.innerText = originalText;
                }
                // ç¡®ä¿åœ¨ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿèƒ½æ¸…é™¤åŠ è½½çŠ¶æ€
                document.getElementById('loading').style.display = 'none';
            });
        }
        
        // --- è¡¨æ ¼æ¸²æŸ“å‡½æ•° (ä½¿ç”¨ 5 åˆ—ç»“æ„ä»¥å±•ç¤º CNAME è¿½æº¯ç»“æœ) ---
        function renderTable(results) {
            const resultsDiv = document.getElementById('results');
            const oldTable = document.getElementById('resultsTable');
            if (oldTable) oldTable.remove();

            if (results.length === 0) {
                return; 
            }

            let html = `<table id="resultsTable">
                            <thead>
                                <tr>
                                    <th>åŸå§‹æŸ¥è¯¢åŸŸå</th> 
                                    <th>æœ€ç»ˆè§£æåŸŸå/CNAME</th> 
                                    <th>DNS æœåŠ¡å™¨</th> 
                                    <th>çŠ¶æ€/ç±»å‹</th>
                                    <th>IP åœ°å€/é”™è¯¯ä¿¡æ¯</th> 
                                    <th>å¯¹åº”å‚å•†</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            results.forEach(record => {
                const vendorDisplay = record.vendor || 'N/A'; 
                // æå–çŠ¶æ€ç é¦–éƒ¨
                const statusType = record.status ? record.status.split(':')[0].toUpperCase() : 'UNKNOWN';
                const statusClass = `status-${statusType}`;
                
                html += `
                    <tr>
                        <td>${record.query_for}</td>               
                        <td>${record.final_resolver_domain}</td>  
                        <td>${record.dns_server}</td>             
                        <td class="${statusClass}">${record.type} (${record.status})</td>
                        <td>${record.value}</td>                   
                        <td>${vendorDisplay}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            
            resultsDiv.innerHTML += html;
        }

        // --- è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰ç­›é€‰ç»“æœ ---
        function getFilteredResults() {
            const filterDomain = document.getElementById('filterDomain').value.toLowerCase();
            const filterVendor = document.getElementById('filterVendor').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value.toUpperCase(); 
            
            // ğŸš¨ æ£€æŸ¥ç‚¹ï¼šç¡®ä¿è¿™é‡Œè·å–çš„æ˜¯æ–°çš„ <select> æ§ä»¶çš„å€¼
            // è¿™ä¸ªå€¼è¦ä¹ˆæ˜¯ç©ºå­—ç¬¦ä¸² ""ï¼ˆæ˜¾ç¤ºå…¨éƒ¨ï¼‰ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªç²¾ç¡® IP
            const filterDnsServer = document.getElementById('filterDnsServer').value.toLowerCase(); 

            // æ£€æŸ¥ LAST_QUERY_RESULTS æ˜¯å¦å·²åŠ è½½
            if (!LAST_QUERY_RESULTS) {
                return [];
            }
            
            return LAST_QUERY_RESULTS.filter(record => {
                // 1. åŸŸåç­›é€‰
                const domainMatch = record.query_for ? record.query_for.toLowerCase().includes(filterDomain) : false;
                
                // 2. å‚å•†ç­›é€‰
                const vendorName = record.vendor ? record.vendor.toLowerCase() : '';
                const vendorMatch = !filterVendor || vendorName.includes(filterVendor);

                // 3. DNS æœåŠ¡å™¨ç²¾ç¡®ç­›é€‰ (å·²ä¿®æ”¹ä¸ºä¸‹æ‹‰åˆ—è¡¨é€»è¾‘)
                const dnsServerIp = record.dns_server ? record.dns_server.toLowerCase() : '';
                
                // å¦‚æœ filterDnsServer æ˜¯ç©ºå­—ç¬¦ä¸² (å³é€‰æ‹©äº† '-- æ˜¾ç¤ºå…¨éƒ¨ --')ï¼Œåˆ™åŒ¹é…ï¼›
                // å¦åˆ™ï¼Œè¦æ±‚è®°å½•çš„ DNS IP å¿…é¡»ç²¾ç¡®ç­‰äºç­›é€‰å€¼ã€‚
                const dnsServerMatch = !filterDnsServer || dnsServerIp === filterDnsServer; 

                // 4. çŠ¶æ€ç­›é€‰
                const statusValue = record.status ? record.status.split(':')[0].toUpperCase() : '';
                const statusMatch = !filterStatus || statusValue === filterStatus;
                
                // 5. ç»„åˆæ‰€æœ‰åŒ¹é…æ¡ä»¶
                return domainMatch && vendorMatch && dnsServerMatch && statusMatch;
            });
        }
		
		// --- è¾…åŠ©å‡½æ•°ï¼šåŠ¨æ€å¡«å…… DNS æœåŠ¡å™¨ç­›é€‰åˆ—è¡¨ ---
        function populateDnsServerFilter() {
            const selectElement = document.getElementById('filterDnsServer');
            // æ¸…ç©ºæ—§çš„é€‰é¡¹ï¼Œä½†ä¿ç•™ç¬¬ä¸€ä¸ª 'æ˜¾ç¤ºå…¨éƒ¨' é€‰é¡¹
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            if (!LAST_QUERY_RESULTS || LAST_QUERY_RESULTS.length === 0) {
                return;
            }

            // ä½¿ç”¨ Set ç»“æ„è·å–å”¯ä¸€çš„ DNS æœåŠ¡å™¨ IP åˆ—è¡¨
            const uniqueDnsServers = new Set();
            LAST_QUERY_RESULTS.forEach(record => {
                if (record.dns_server) {
                    uniqueDnsServers.add(record.dns_server);
                }
            });

            // å°†å”¯ä¸€çš„ IP æ’åºåæ·»åŠ åˆ° select æ§ä»¶ä¸­
            const sortedDnsServers = Array.from(uniqueDnsServers).sort();
            
            sortedDnsServers.forEach(ip => {
                const option = document.createElement('option');
                option.value = ip;
                option.textContent = ip;
                selectElement.appendChild(option);
            });
            
            // ğŸš¨ è§¦å‘ applyFiltersï¼Œç¡®ä¿ä¸‹æ‹‰åˆ—è¡¨å†…å®¹æ›´æ–°åç»“æœä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
            applyFilters();
        }


        // --- æ ¸å¿ƒç­›é€‰é€»è¾‘ (ä¿ç•™æ‰€æœ‰å®‰å…¨æ£€æŸ¥å’Œé€»è¾‘) --- 
        function applyFilters() {
            const resultsDiv = document.getElementById('results');
            const filteredResults = getFilteredResults();
            const exportButton = document.getElementById('exportButton');

            // ç§»é™¤æ—§è¡¨æ ¼
            document.getElementById('resultsTable')?.remove(); 
            // ç§»é™¤â€œæ²¡æœ‰åŒ¹é…â€çš„æ¶ˆæ¯
            document.getElementById('no-match-message')?.remove();

            if (!LAST_QUERY_RESULTS || LAST_QUERY_RESULTS.length === 0) {
                exportButton.disabled = true;
                return;
            }

            // å¯ç”¨/ç¦ç”¨å¯¼å‡ºæŒ‰é’®
            exportButton.disabled = filteredResults.length === 0;

            if (filteredResults.length === 0) {
                const p = document.createElement('p');
                p.id = 'no-match-message';
                p.innerText = 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰åŒ¹é…çš„ç»“æœã€‚';
                resultsDiv.appendChild(p);
                return;
            }

            // --- è¡¨æ ¼æ¸²æŸ“å¼€å§‹ ---
            let html = `<table id="resultsTable">
                            <thead>
                                <tr>
                                    <th>åŸå§‹æŸ¥è¯¢åŸŸå</th> 
                                    <th>æœ€ç»ˆè§£æåŸŸå/CNAME</th> 
                                    <th>ä½¿ç”¨çš„ DNS æœåŠ¡å™¨</th> <th>çŠ¶æ€/ç±»å‹</th>
                                    <th>IP åœ°å€/é”™è¯¯ä¿¡æ¯</th> 
                                    <th>å¯¹åº”å‚å•†</th>
                                </tr>
                            </thead>
                            <tbody>`;

            // éå†ç­›é€‰åçš„ç»“æœå¹¶ç”Ÿæˆè¡¨æ ¼è¡Œ
            filteredResults.forEach(record => {
                const vendorDisplay = record.vendor || 'N/A'; 
                // æå–çŠ¶æ€ç é¦–éƒ¨
                const statusType = record.status ? record.status.split(':')[0].toUpperCase() : 'UNKNOWN';
                const statusClass = `status-${statusType}`;
                
                // ğŸš¨ å…³é”®ä¿®æ­£ï¼šç¡®ä¿æ¯ä¸ªå•å…ƒæ ¼çš„æ•°æ®æºä¸è¡¨å¤´ä¸¥æ ¼å¯¹åº”
                html += `
                    <tr>
                        <td>${record.query_for}</td>               
                        <td>${record.final_resolver_domain}</td>  
                        <td>${record.dns_server}</td>             
                        <td class="${statusClass}">${record.type} (${record.status})</td>
                        <td>${record.value}</td>                   
                        <td>${vendorDisplay}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            
            // å°†è¡¨æ ¼æ·»åŠ åˆ° results åŒºåŸŸ (æ³¨æ„ï¼šæ ‡é¢˜å’Œè€—æ—¶ä¿¡æ¯å·²åœ¨æŸ¥è¯¢æˆåŠŸå›è°ƒä¸­è®¾ç½®)
            resultsDiv.insertAdjacentHTML('beforeend', html);
        }
        // --- æ ¸å¿ƒç­›é€‰é€»è¾‘ç»“æŸ ---

        // --- å¯¼å‡ºåŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ ---
        function exportResults() {
            const resultsToExport = getFilteredResults(); // è·å–å½“å‰ç­›é€‰åçš„ç»“æœ
            const exportButton = document.getElementById('exportButton');
            
            if (resultsToExport.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ã€‚');
                return;
            }

            exportButton.disabled = true;
            const originalText = exportButton.innerText;
            exportButton.innerText = 'æ­£åœ¨ç”Ÿæˆ...';

            // å‘é€ POST è¯·æ±‚åˆ°æ–°çš„å¯¼å‡º API
            fetch("{{ url_for('export_query_results') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ results: resultsToExport }) 
            })
            .then(response => {
                // ğŸš¨ å…³é”®ä¿®æ­£ 1ï¼šå®‰å…¨æ£€æŸ¥ï¼Œå…ˆæ£€æŸ¥çŠ¶æ€ç 
                if (!response.ok) {
                    // å¦‚æœä¸æ˜¯ 200 OKï¼Œå°è¯•è¯»å–æ–‡æœ¬é”™è¯¯ä¿¡æ¯
                    return response.text().then(text => {
                        try {
                            // å¦‚æœé”™è¯¯ä¿¡æ¯æ˜¯ JSON æ ¼å¼ï¼ˆä¾‹å¦‚ 400 é”™è¯¯ï¼‰
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || `HTTP é”™è¯¯ ${response.status}: æœªçŸ¥ API é”™è¯¯`);
                        } catch (e) {
                            // å¦‚æœé”™è¯¯ä¿¡æ¯æ˜¯æ™®é€šæ–‡æœ¬æˆ– HTMLï¼ˆä¾‹å¦‚ 500 é”™è¯¯é¡µï¼‰
                            throw new Error(`HTTP é”™è¯¯ ${response.status}: æœåŠ¡å™¨è¿”å›é JSON é”™è¯¯ (${text.substring(0, 100)}...)`);
                        }
                    });
                }
                
                // å…³é”®ä¿®æ­£ 2ï¼šå¦‚æœçŠ¶æ€ç æ˜¯ OKï¼Œç›´æ¥è¿”å› Blob
                return response.blob();
            })
            .then(blob => {
                // å…³é”®ä¿®æ­£ 3ï¼šæ‰§è¡Œä¸‹è½½æ“ä½œ
                if (blob instanceof Blob) {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    const filename = `dns_check_results_${new Date().toISOString().slice(0, 10)}.csv`;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert(`æ–‡ä»¶ ${filename} å·²å¼€å§‹ä¸‹è½½ã€‚`);
                } else {
                     // æå°‘å‘ç”Ÿï¼Œä½†ä½œä¸ºå®‰å…¨æ£€æŸ¥
                    throw new Error('æœåŠ¡å™¨æœªè¿”å›æœ‰æ•ˆçš„æ–‡ä»¶æ•°æ®ã€‚');
                }
                
                exportButton.innerText = originalText;
                exportButton.disabled = false;
                
            })
            .catch(error => {
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
                
                // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½è¦è¿˜åŸæŒ‰é’®çŠ¶æ€
                exportButton.innerText = originalText;
                exportButton.disabled = false;
            });
        }
        // --- ç»“æŸ: å¯¼å‡ºåŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ ---


        document.addEventListener('DOMContentLoaded', function() {
            const dnsServersInput = document.getElementById('dnsServers');
            const savedServers = localStorage.getItem(DNS_SERVERS_KEY);
            const loadingDiv = document.getElementById('loading');
            
            if (savedServers) {
                // å°†ä¿å­˜çš„ DNS æœåŠ¡å™¨ IP å¡«å› textarea
                dnsServersInput.value = savedServers.split(',').join('\n'); 
            } else {
                dnsServersInput.value = '8.8.8.8'; 
            }

            // --- 1. å®æ—¶æŸ¥è¯¢é€»è¾‘ ---
            document.getElementById('queryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const domains = document.getElementById('domains').value;
                const dnsServers = dnsServersInput.value;
                const exportButton = document.getElementById('exportButton');

                // å°† textarea ä¸­çš„å¤šè¡Œ IP è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²å¹¶ä¿å­˜
                const dnsServersComma = dnsServers.split('\n').map(s => s.trim()).filter(s => s.length > 0).join(',');
                localStorage.setItem(DNS_SERVERS_KEY, dnsServersComma);
                
                loadingDiv.style.display = 'block';
                document.getElementById('results').innerHTML = ''; // æ¸…ç©ºç»“æœ
                
                // ä¿æŠ¤æ€§ç¦ç”¨å¯¼å‡ºæŒ‰é’®
                if (exportButton) { 
                    exportButton.disabled = true; 
                }

                const payload = { domains: domains, dns_servers: dnsServersComma };

                submitForm('/query', payload, 'queryButton', 'queryStatusMessage', (data) => {
                    loadingDiv.style.display = 'none';
                    
                    LAST_QUERY_RESULTS = data.results; 
                    // è®¾ç½®æŸ¥è¯¢ç»“æœçš„å®¹å™¨å†…å®¹ï¼ŒåŒ…æ‹¬æ ‡é¢˜å’Œè€—æ—¶
                    document.getElementById('results').innerHTML = `<h2>æŸ¥è¯¢ç»“æœ (${data.results.length} æ¡è®°å½•)</h2>
                                                                   <p>æ€»è€—æ—¶: ${data.time_taken}</p>`;
                    // å…³é”®ä¿®æ”¹ï¼šå…ˆå¡«å…… DNS æœåŠ¡å™¨ç­›é€‰åˆ—è¡¨
                    populateDnsServerFilter();
					
					// applyFilters(); // è‡ªåŠ¨åº”ç”¨ç­›é€‰å¹¶æ¸²æŸ“è¡¨æ ¼ï¼Œå¯ç”¨å¯¼å‡ºæŒ‰é’®
                });
            });


            // --- 2. å¯¼å‡ºæŒ‰é’®äº‹ä»¶ç»‘å®š ---
            document.getElementById('exportButton').addEventListener('click', exportResults);

            // --- 3. ç­›é€‰å™¨äº‹ä»¶ç»‘å®š ---
            document.getElementById('filterDomain').addEventListener('input', applyFilters);
            document.getElementById('filterVendor').addEventListener('input', applyFilters);
			// æ–°å¢ï¼šDNS æœåŠ¡å™¨ç­›é€‰äº‹ä»¶ç»‘å®š
            document.getElementById('filterDnsServer').addEventListener('change', applyFilters);
            document.getElementById('filterStatus').addEventListener('change', applyFilters);
        });
    </script>
</body>
</html>