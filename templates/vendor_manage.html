<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å‚å•† IP æ˜ å°„ç®¡ç†</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #333; margin-top: 25px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], input[type="submit"], button { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-row > div { flex: 1; }
        button.add-vendor-btn { background-color: #ffc107; color: black; border: 1px solid #c09b06; cursor: pointer; }
        button.add-vendor-btn:hover { background-color: #e0a800; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border: 1px solid #ddd; }
        th { background-color: #5bc0de; color: white; }
        .delete-btn { background-color: #dc3545; color: white; border: none; cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: background-color 0.3s; }
        .delete-btn:hover { background-color: #c82333; }
        
        /* æ–°å¢çš„ä¿®æ”¹æŒ‰é’®æ ·å¼ */
        .edit-btn { background-color: #007bff; color: white; border: none; cursor: pointer; padding: 5px 10px; border-radius: 4px; margin-right: 5px; transition: background-color 0.3s; }
        .edit-btn:hover { background-color: #0056b3; }

        .status-message { margin-top: 15px; font-weight: bold; }
        .nav-link { margin-left: 15px; color: #007bff; text-decoration: none; font-weight: bold;}

        /* æ–°å¢ï¼šæ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none; position: fixed; z-index: 1; left: 0; top: 0; 
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 15% auto; padding: 20px; 
            border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
        #saveEditButton { background-color: #28a745; color: white; margin-top: 20px; }
        #saveEditButton:hover { background-color: #1e7e34; }
    </style>
</head>
<body>
    <div class="container">
        <div style="float: right; margin-top: -50px;">
            <p>
                <a href="{{ url_for('index') }}" class="nav-link">[è¿”å›ä¸»é¡µ]</a> 
                <a href="{{ url_for('logout') }}" style="color: red; margin-left: 15px;">[ç™»å‡º]</a>
            </p>
        </div>
        
        <h1>ğŸ­ å‚å•† IP æ˜ å°„ç®¡ç†</h1>
        <div style="clear: both;"></div>

        <hr style="margin: 30px 0;">
        <h2>ğŸ“ å¢åŠ å‚å•† IP æ˜ å°„</h2>

        <form id="addVendorForm">
            <div class="form-row">
                <div>
                    <label for="vendorName">å‚å•†åç§°:</label>
                    <input type="text" id="vendorName" required placeholder="ä¾‹å¦‚: å†…éƒ¨æ ¸å¿ƒä¸šåŠ¡">
                </div>
                <div>
                    <label for="cidrRange">CIDR èŒƒå›´ (ä¾‹å¦‚: 10.0.0.0/8):</label>
                    <input type="text" id="cidrRange" required placeholder="ä¾‹å¦‚: 10.0.0.0/8">
                </div>
            </div>
            
            <label for="vendorDescription">æè¿° (å¯é€‰):</label>
            <input type="text" id="vendorDescription" placeholder="è¯¥IPæ®µç”¨äº... ">

            <button type="submit" id="addVendorButton" class="add-vendor-btn">æ·»åŠ å‚å•† IP</button>
        </form>
        
        <div id="vendorStatusMessage" class="status-message"></div>

        <hr style="margin: 30px 0;">
        
        <h2>ğŸ” ç­›é€‰å‚å•†</h2>
        <div class="form-row" style="margin-bottom: 20px;">
            <div style="flex: none; width: 100%;">
                <input type="text" id="filterVendorInput" placeholder="è¯·è¾“å…¥å‚å•†åç§°ã€CIDR æˆ– IP åœ°å€è¿›è¡Œç­›é€‰..." style="width: 100%;">
            </div>
        </div>
        
        <hr style="margin: 30px 0;">
        <h2>ğŸ“‘ ç°æœ‰å‚å•†åˆ—è¡¨</h2>
        <div id="vendorListContainer">
            <p>æ­£åœ¨åŠ è½½å‚å•†æ•°æ®...</p>
        </div>
    </div>
    
    <div id="editVendorModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>âœï¸ ä¿®æ”¹å‚å•† IP æ˜ å°„</h2>
            <form id="editVendorForm">
                <input type="hidden" id="editVendorId">
                
                <label for="editVendorName">å‚å•†åç§°:</label>
                <input type="text" id="editVendorName" required>
                
                <label for="editCidrRange">CIDR èŒƒå›´ (ä¾‹å¦‚: 10.0.0.0/8):</label>
                <input type="text" id="editCidrRange" required>
                
                <label for="editVendorDescription">æè¿° (å¯é€‰):</label>
                <input type="text" id="editVendorDescription">
                
                <button type="submit" id="saveEditButton">ä¿å­˜ä¿®æ”¹</button>
            </form>
            <div id="editStatusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        // æ–°å¢: ç”¨äºå­˜å‚¨æ‰€æœ‰å‚å•†æ•°æ®çš„å…¨å±€å˜é‡
        let ALL_VENDORS = []; 

        document.addEventListener('DOMContentLoaded', () => {
             fetchVendors();
             
             // æ–°å¢: ç­›é€‰å™¨äº‹ä»¶ç»‘å®š
             document.getElementById('filterVendorInput').addEventListener('input', applyVendorFilters);
        });

        // ====================================================================
        //                   æ–°å¢: IP/CIDR åŒ¹é…å·¥å…·å‡½æ•° (ä»…æ”¯æŒ IPv4)
        // ====================================================================

        /**
         * æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ IPv4 åœ°å€æ ¼å¼ã€‚
         * @param {string} ipAddressStr 
         */
        function isValidIPv4(ipAddressStr) {
            // åŒ¹é… 0-255.0-255.0-255.0-255 æ ¼å¼çš„ IP åœ°å€
            const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipv4Regex.test(ipAddressStr)) {
                return false;
            }
            // è¿›ä¸€æ­¥æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†æ˜¯å¦åœ¨ 0-255 èŒƒå›´å†…
            return ipAddressStr.split('.').every(part => {
                const num = parseInt(part, 10);
                return num >= 0 && num <= 255;
            });
        }
        
        /**
         * å°† IPv4 åœ°å€å­—ç¬¦ä¸²è½¬æ¢ä¸º 32 ä½æ•´æ•° (Long)ã€‚
         * @param {string} ipAddressStr 
         */
        function ipv4ToLong(ipAddressStr) {
            // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ IPv4ï¼Œè¿”å› NaN æˆ–æŠ›å‡ºé”™è¯¯
            if (!isValidIPv4(ipAddressStr)) return NaN;
            
            const parts = ipAddressStr.split('.');
            let long = 0;
            // (a * 256^3) + (b * 256^2) + (c * 256^1) + d
            for (let i = 0; i < 4; i++) {
                // ä½¿ç”¨ä½è¿ç®—æ›¿ä»£ä¹˜æ³•å¯èƒ½æ›´é«˜æ•ˆï¼Œä½†åœ¨ JS ä¸­éœ€æ³¨æ„ 32ä½æ•´æ•°é™åˆ¶ï¼Œæ­¤å¤„ä½¿ç”¨ä¹˜æ³•å¹¶ä¾èµ– JS çš„ Number ç±»å‹
                long = (long * 256) + parseInt(parts[i], 10);
            }
            return long;
        }

        /**
         * æ£€æŸ¥ç»™å®šçš„ IP åœ°å€æ˜¯å¦åŒ…å«åœ¨ CIDR èŒƒå›´å†…ã€‚
         * @param {string} ipAddress IP åœ°å€å­—ç¬¦ä¸²
         * @param {string} cidrRange CIDR èŒƒå›´å­—ç¬¦ä¸² (å¦‚: 192.168.1.0/24)
         */
        function isIpInCidr(ipAddress, cidrRange) {
            try {
                if (!isValidIPv4(ipAddress)) return false;
                if (!cidrRange.includes('/')) return false;

                const [networkAddressStr, maskLengthStr] = cidrRange.split('/');
                const ipLong = ipv4ToLong(ipAddress);
                const networkLong = ipv4ToLong(networkAddressStr);
                const maskLength = parseInt(maskLengthStr, 10);

                // æ£€æŸ¥ IP åœ°å€å’Œç½‘ç»œåœ°å€æ˜¯å¦æœ‰æ•ˆ
                if (isNaN(ipLong) || isNaN(networkLong)) return false;
                // æ£€æŸ¥æ©ç é•¿åº¦æœ‰æ•ˆæ€§ (IPv4 èŒƒå›´ 0-32)
                if (isNaN(maskLength) || maskLength < 0 || maskLength > 32) return false;

                // è®¡ç®—å­ç½‘æ©ç  (ä½¿ç”¨å·¦ç§»ä½æ“ä½œç¬¦)
                // JS ä¸­çš„ä½è¿ç®—æ˜¯ 32 ä½å¸¦ç¬¦å·æ•´æ•°ï¼Œä½¿ç”¨ >>> æ— ç¬¦å·å³ç§»ç¡®ä¿å¾—åˆ°æ­£ç¡®çš„ç½‘ç»œæ©ç 
                const mask = -1 << (32 - maskLength); 

                // æ¯”è¾ƒ IP åœ°å€å’Œç½‘ç»œåœ°å€ç»è¿‡æ©ç åçš„ç»“æœ
                return (ipLong & mask) === (networkLong & mask);

            } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯ï¼Œè§†ä¸ºä¸åŒ¹é…
                return false;
            }
        }


        // ====================================================================
        //                   æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
        // ====================================================================

        function fetchVendors() {
            const container = document.getElementById('vendorListContainer');
            container.innerHTML = '<p>æ­£åœ¨åŠ è½½å‚å•†æ•°æ®...</p>';
            
            fetch("{{ url_for('get_vendors') }}")
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        ALL_VENDORS = data.vendors; // å­˜å‚¨æ‰€æœ‰å‚å•†æ•°æ®
                        applyVendorFilters();        // åº”ç”¨ç­›é€‰å¹¶æ¸²æŸ“
                    } else {
                        container.innerHTML = `<p style="color: red;">åŠ è½½å¤±è´¥: ${data.message}</p>`;
                    }
                })
                .catch(error => {
                    container.innerHTML = `<p style="color: red;">ç½‘ç»œé”™è¯¯: ${error}</p>`;
                });
        }
        
        /**
         * åº”ç”¨ç­›é€‰é€»è¾‘ï¼Œæ”¯æŒå‚å•†åç§°ã€CIDR å­—ç¬¦ä¸²åŒ…å«ã€ä»¥åŠ IP åœ°å€æ®µç²¾ç¡®åŒ¹é…ã€‚
         */
        function applyVendorFilters() {
            const filterInput = document.getElementById('filterVendorInput');
            const filterText = filterInput.value.toLowerCase().trim();

            if (filterText === '') {
                 renderVendorTable(ALL_VENDORS);
                 return;
            }
            
            let filteredVendors = [];

            // æ£€æŸ¥è¾“å…¥æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ IPv4 åœ°å€ (ç²¾ç¡®åŒ¹é… IP åœ°å€æ®µ)
            if (isValidIPv4(filterText)) {
                // å¦‚æœæ˜¯æœ‰æ•ˆçš„ IP åœ°å€ï¼Œä½¿ç”¨ç²¾ç¡®çš„ CIDR åŒ…å«æ£€æŸ¥
                filteredVendors = ALL_VENDORS.filter(vendor => 
                    isIpInCidr(filterText, vendor.cidr_range)
                );
            } else {
                // å¦åˆ™ï¼Œä½¿ç”¨å­—ç¬¦ä¸²åŒ…å«æ£€æŸ¥ (åŒ¹é…åç§°ã€éƒ¨åˆ† CIDRã€æè¿°)
                filteredVendors = ALL_VENDORS.filter(vendor => 
                    vendor.vendor_name.toLowerCase().includes(filterText) ||
                    vendor.cidr_range.toLowerCase().includes(filterText) ||
                    (vendor.description && vendor.description.toLowerCase().includes(filterText))
                );
            }
            
            renderVendorTable(filteredVendors);
        }

        function renderVendorTable(vendors) {
            const container = document.getElementById('vendorListContainer');
            
            if (vendors.length === 0 && ALL_VENDORS.length > 0) {
                 container.innerHTML = '<p>æ²¡æœ‰åŒ¹é…å½“å‰ç­›é€‰æ¡ä»¶çš„å‚å•† IP æ˜ å°„è®°å½•ã€‚</p>';
                 return;
            }
            if (vendors.length === 0 && ALL_VENDORS.length === 0) {
                 container.innerHTML = '<p>æ•°æ®åº“ä¸­æš‚æ— å‚å•† IP æ˜ å°„è®°å½•ã€‚</p>';
                 return;
            }
            
            // æ–°å¢: å­˜å‚¨å‚å•†æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿ç¼–è¾‘æ—¶æŸ¥æ‰¾
            window.vendorCache = vendors.reduce((acc, vendor) => {
                acc[vendor.id] = vendor;
                return acc;
            }, {});

            let html = `<table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>å‚å•†åç§°</th>
                                    <th>CIDR èŒƒå›´</th>
                                    <th>æè¿°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            vendors.forEach(vendor => {
                // ä¿®æ”¹ç‚¹ 1: å¢åŠ ä¿®æ”¹æŒ‰é’®
                html += `
                    <tr>
                        <td>${vendor.id}</td>
                        <td>${vendor.vendor_name}</td>
                        <td>${vendor.cidr_range}</td>
                        <td>${vendor.description || 'N/A'}</td>
                        <td>
                            <button class="edit-btn" onclick="editVendor(${vendor.id})">ä¿®æ”¹</button>
                            <button class="delete-btn" onclick="deleteVendor(${vendor.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function deleteVendor(vendorId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ID ä¸º ${vendorId} çš„å‚å•†è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚`)) {
                return;
            }

            const statusDiv = document.getElementById('vendorStatusMessage');
            statusDiv.innerHTML = 'æ­£åœ¨åˆ é™¤...';
            statusDiv.style.color = 'orange';

            fetch(`/delete_vendor/${vendorId}`, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.innerText = data.message;
                    statusDiv.style.color = 'green';
                    fetchVendors(); // åˆ·æ–°åˆ—è¡¨å¹¶é‡æ–°åº”ç”¨ç­›é€‰
                } else {
                    statusDiv.innerText = `åˆ é™¤å¤±è´¥: ${data.message}`;
                    statusDiv.style.color = 'red';
                }
            })
            .catch(error => {
                statusDiv.innerText = `ç½‘ç»œé”™è¯¯: ${error}`;
                statusDiv.style.color = 'red';
            });
        }

        // --- ç¼–è¾‘æ¨¡æ€æ¡†ç›¸å…³å‡½æ•° ---
        function editVendor(vendorId) {
            const vendor = window.vendorCache[vendorId];
            if (!vendor) {
                alert('æœªæ‰¾åˆ°è¯¥å‚å•†æ•°æ®ï¼è¯·å…ˆåˆ·æ–°é¡µé¢ã€‚');
                return;
            }

            // å¡«å……æ¨¡æ€æ¡†è¡¨å•
            document.getElementById('editVendorId').value = vendor.id;
            document.getElementById('editVendorName').value = vendor.vendor_name;
            document.getElementById('editCidrRange').value = vendor.cidr_range;
            document.getElementById('editVendorDescription').value = vendor.description || '';
            document.getElementById('editStatusMessage').innerHTML = ''; // æ¸…ç©ºçŠ¶æ€ä¿¡æ¯

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('editVendorModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('editVendorModal').style.display = 'none';
        }
        
        // ç‚¹å‡»çª—å£å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        window.onclick = function(event) {
            const modal = document.getElementById('editVendorModal');
            if (event.target == modal) {
                closeModal();
            }
        }


        // --- è¡¨å•æäº¤é€»è¾‘ ---
        
        // 1. æ·»åŠ å‚å•†è¡¨å•æäº¤
        document.getElementById('addVendorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const button = document.getElementById('addVendorButton');
            const statusDiv = document.getElementById('vendorStatusMessage');
            
            const payload = {
                vendor_name: document.getElementById('vendorName').value,
                cidr_range: document.getElementById('cidrRange').value,
                description: document.getElementById('vendorDescription').value
            };
            
            statusDiv.innerHTML = '';
            button.disabled = true;
            button.innerText = 'å¤„ç†ä¸­...';

            fetch("{{ url_for('add_vendor') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.innerText = 'æ·»åŠ å‚å•† IP';

                if (data.status === 'success') {
                    statusDiv.innerText = data.message;
                    statusDiv.style.color = 'green';
                    
                    // æ¸…ç©ºè¾“å…¥å¹¶åˆ·æ–°åˆ—è¡¨
                    document.getElementById('vendorName').value = '';
                    document.getElementById('cidrRange').value = '';
                    document.getElementById('vendorDescription').value = '';
                    fetchVendors(); 
                } else {
                    statusDiv.innerText = `æ“ä½œå¤±è´¥: ${data.message}`;
                    statusDiv.style.color = 'red';
                }
            })
            .catch(error => {
                button.disabled = false;
                button.innerText = 'æ·»åŠ å‚å•† IP';
                statusDiv.innerText = `ç½‘ç»œæˆ–æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error}`;
                statusDiv.style.color = 'red';
            });
        });

        // 2. ä¿®æ”¹å‚å•†è¡¨å•æäº¤
        document.getElementById('editVendorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const vendorId = document.getElementById('editVendorId').value;
            const button = document.getElementById('saveEditButton');
            const statusDiv = document.getElementById('editStatusMessage');
            
            const payload = {
                vendor_name: document.getElementById('editVendorName').value,
                cidr_range: document.getElementById('editCidrRange').value,
                description: document.getElementById('editVendorDescription').value
            };
            
            statusDiv.innerHTML = '';
            button.disabled = true;
            button.innerText = 'ä¿å­˜ä¸­...';

            // è°ƒç”¨æ›´æ–° API
            fetch(`/update_vendor/${vendorId}`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.innerText = 'ä¿å­˜ä¿®æ”¹';

                if (data.status === 'success') {
                    statusDiv.innerText = data.message;
                    statusDiv.style.color = 'green';
                    closeModal(); // å…³é—­æ¨¡æ€æ¡†
                    fetchVendors(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    statusDiv.innerText = `æ“ä½œå¤±è´¥: ${data.message}`;
                    statusDiv.style.color = 'red';
                }
            })
            .catch(error => {
                button.disabled = false;
                button.innerText = 'ä¿å­˜ä¿®æ”¹';
                statusDiv.innerText = `ç½‘ç»œæˆ–æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error}`;
                statusDiv.style.color = 'red';
            });
        });
    </script>
</body>
</html>