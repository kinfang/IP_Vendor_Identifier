<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>IP å‚å•†è¯†åˆ«å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #333; margin-top: 25px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        textarea, input[type="text"], select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; }
        textarea { height: 120px; }
        
        /* é€šç”¨æŒ‰é’®æ ·å¼ - ä»…åº”ç”¨äºè¡¨å•æŒ‰é’®ï¼Œä¸å½±å“å¯¼å‡ºæŒ‰é’® */
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #218838; }
        
        /* --- å¯¼å‡ºæŒ‰é’®çš„ä¸“ç”¨æ ·å¼ --- */
        #exportButton { 
            background-color: #17a2b8; 
            color: white; 
            /* è¦†ç›–é€šç”¨çš„ margin-top: 20px; å¹¶å¢åŠ åº•éƒ¨é—´è· */
            margin-top: 10px; 
            margin-bottom: 20px; 
            padding: 8px 15px; 
            font-size: 14px; 
            width: auto; /* ç¡®ä¿å®ƒä¸ä¼šå æ® 100% å®½åº¦ */
        }
        #exportButton:hover:not(:disabled) { background-color: #117a8b; }
        #exportButton:disabled { background-color: #ccc; cursor: not-allowed; }

        #results { margin-top: 30px; }
        #results table { width: 100%; border-collapse: collapse; margin-top: 15px;}
        #results th, #results td { padding: 10px; text-align: left; border: 1px solid #ddd; font-size: 14px; }
        #results th { background-color: #007bff; color: white; }
        .status-NXDOMAIN, .status-TIMEOUT, .status-ERROR { color: red; font-weight: bold; }
        .status-OK { color: green; font-weight: bold; }
        .loading { text-align: center; margin-top: 20px; font-size: 1.1em; color: #555; }
        .add-vendor-btn { background-color: #ffc107; color: black; border: 1px solid #c09b06; margin-top: 5px;}
        .add-vendor-btn:hover { background-color: #e0a800; }
        #filterControls { background-color: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee; }
        .nav-link { margin-left: 15px; color: #007bff; text-decoration: none; font-weight: bold;}
        .status-message { margin-top: 15px; font-weight: bold; } 
    </style>
</head>
<body>
    <div class="container">
        <div style="float: right; margin-top: -50px;">
            <p>
                å½“å‰ç”¨æˆ·: <strong>{{ current_user.id }}</strong>
                <a href="{{ url_for('vendor_manage_page') }}" class="nav-link">[å‚å•†ç®¡ç†]</a> 
                <a href="{{ url_for('logout') }}" style="color: red; margin-left: 15px;">[ç™»å‡º]</a>
            </p>
        </div>
        
        <h1>ğŸŒ IP å‚å•†è¯†åˆ«å·¥å…·</h1>
        <div style="clear: both;"></div>

        <h2>æŸ¥è¯¢é…ç½®</h2>
        <form id="queryForm">
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="dnsServers">è‡ªå®šä¹‰ DNS æœåŠ¡å™¨ IP (æ¯è¡Œä¸€ä¸ª):</label>
                    <textarea id="dnsServers" rows="4"></textarea> 
                </div>
                <div style="flex: 1;">
                    <label for="domains">åŸŸååˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª):</label>
                    <textarea id="domains" rows="4" placeholder="ä¾‹å¦‚ï¼š&#10;example.com&#10;www.google.com"></textarea>
                </div>
            </div>
            <button type="submit" id="queryButton">æ‰§è¡Œå®æ—¶æŸ¥è¯¢</button>
            <div id="queryStatusMessage" class="status-message"></div>
        </form>

        <hr style="margin: 30px 0;">
        <h2>ğŸ” ç­›é€‰ç»“æœ</h2>
        
        <button id="exportButton" disabled>å¯¼å‡ºå½“å‰ç­›é€‰ç»“æœ (CSV)</button>
        
        <div id="filterControls" style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1;">
                <label for="filterDomain">ç­›é€‰åŸŸå:</label>
                <input type="text" id="filterDomain" placeholder="è¾“å…¥åŸŸåå…³é”®è¯">
            </div>
            <div style="flex: 1;">
                <label for="filterVendor">ç­›é€‰å‚å•†:</label>
                <input type="text" id="filterVendor" placeholder="è¾“å…¥å‚å•†å…³é”®è¯">
            </div>
            <div style="flex: 1;">
                <label for="filterStatus">ç­›é€‰çŠ¶æ€:</label>
                <select id="filterStatus">
                    <option value="">-- æ˜¾ç¤ºå…¨éƒ¨ --</option>
                    <option value="OK">è§£ææˆåŠŸ (OK)</option>
                    <option value="NXDOMAIN">åŸŸåä¸å­˜åœ¨ (NXDOMAIN)</option>
                    <option value="TIMEOUT">è¶…æ—¶ (TIMEOUT)</option>
                    <option value="ERROR">æŸ¥è¯¢é”™è¯¯ (ERROR)</option>
                </select>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">æ­£åœ¨æŸ¥è¯¢ï¼Œè¯·ç¨å€™...</div>
        <div id="results">
            </div>
    </div>

    <script>
        let LAST_QUERY_RESULTS = [];
        const DNS_SERVERS_KEY = 'lastUsedDnsServers';

        document.addEventListener('DOMContentLoaded', () => {
            const savedServers = localStorage.getItem(DNS_SERVERS_KEY);
            const dnsServersInput = document.getElementById('dnsServers');
            
            if (savedServers) {
                dnsServersInput.value = savedServers;
            } else {
                dnsServersInput.value = '8.8.8.8'; 
            }
            
            // ç»‘å®šå¯¼å‡ºæŒ‰é’®äº‹ä»¶
            document.getElementById('exportButton').addEventListener('click', exportResults);
        });
        
        // --- å¯¼å‡ºåŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ ---
        function exportResults() {
            const resultsToExport = getFilteredResults(); // è·å–å½“å‰ç­›é€‰åçš„ç»“æœ
            const exportButton = document.getElementById('exportButton');
            exportButton.disabled = true;
            const originalText = exportButton.innerText;
            exportButton.innerText = 'æ­£åœ¨ç”Ÿæˆ...';

            // å‘é€ POST è¯·æ±‚åˆ°æ–°çš„å¯¼å‡º API
            fetch("{{ url_for('export_query_results') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ results: resultsToExport })
            })
            .then(response => {
                if (response.ok && response.headers.get('content-type').includes('text/csv')) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ã€‚');
                    });
                }
            })
            .then(blob => {
                if (blob instanceof Blob) {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    const filename = 'dns_query_results.csv';
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                }
                
                exportButton.innerText = originalText;
                exportButton.disabled = false;
                
            })
            .catch(error => {
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
                exportButton.innerText = originalText;
                exportButton.disabled = false;
            });
        }
        // --- ç»“æŸ: å¯¼å‡ºåŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ ---


        // --- é€šç”¨ Fetch å‡½æ•° ---
        function submitForm(endpoint, payload, buttonId, statusDivId, successCallback) {
            const button = document.getElementById(buttonId);
            const statusDiv = document.getElementById(statusDivId);

            if (!statusDiv) {
                console.error(`Status Div with ID ${statusDivId} not found!`);
                button.disabled = false;
                button.innerText = (buttonId === 'queryButton') ? 'æ‰§è¡Œå®æ—¶æŸ¥è¯¢' : 'æ“ä½œ';
                return;
            }

            statusDiv.innerHTML = '';
            button.disabled = true;
            button.innerText = 'å¤„ç†ä¸­...';

            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.innerText = (buttonId === 'queryButton') ? 'æ‰§è¡Œå®æ—¶æŸ¥è¯¢' : 'æ·»åŠ å‚å•† IP';

                if (data.status === 'success') {
                    statusDiv.innerText = data.message || 'æ“ä½œæˆåŠŸã€‚';
                    statusDiv.style.color = 'green';
                    if (successCallback) successCallback(data);
                } else {
                    statusDiv.innerText = `æ“ä½œå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`;
                    statusDiv.style.color = 'red';
                }
            })
            .catch(error => {
                button.disabled = false;
                button.innerText = (buttonId === 'queryButton') ? 'æ‰§è¡Œå®æ—¶æŸ¥è¯¢' : 'æ·»åŠ å‚å•† IP';
                statusDiv.innerText = `ç½‘ç»œæˆ–æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error}`;
                statusDiv.style.color = 'red';
            });
        }

        // --- è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰ç­›é€‰ç»“æœ ---
        function getFilteredResults() {
            const filterDomain = document.getElementById('filterDomain').value.toLowerCase();
            const filterVendor = document.getElementById('filterVendor').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value.toUpperCase();

            return LAST_QUERY_RESULTS.filter(record => {
                const domainMatch = record.domain.toLowerCase().includes(filterDomain);
                const vendorMatch = (record.vendor || '').toLowerCase().includes(filterVendor);
                
                let statusText = record.status.split(':')[0].toUpperCase();
                if (!['OK', 'NXDOMAIN', 'TIMEOUT'].includes(statusText)) {
                     statusText = 'ERROR'; 
                }
                const statusMatch = !filterStatus || statusText === filterStatus;
                
                return domainMatch && vendorMatch && statusMatch;
            });
        }


        // --- æ ¸å¿ƒç­›é€‰é€»è¾‘ (ä¿®å¤æ¸²æŸ“é€»è¾‘) ---
        function applyFilters() {
            const resultsDiv = document.getElementById('results');
            const filteredResults = getFilteredResults();
            const exportButton = document.getElementById('exportButton');

            if (LAST_QUERY_RESULTS.length === 0) {
                resultsDiv.innerHTML = "<p>è¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢ã€‚</p>";
                exportButton.disabled = true;
                return;
            }
            
            exportButton.disabled = filteredResults.length === 0;

            const oldTable = document.getElementById('resultsTable');
            const noMatchP = document.getElementById('no-match-message');

            if (filteredResults.length === 0) {
                 if (oldTable) oldTable.remove(); // ç§»é™¤æ—§è¡¨æ ¼
                 
                 // å¦‚æœæ²¡æœ‰â€œæ²¡æœ‰åŒ¹é…â€çš„æ¶ˆæ¯ï¼Œåˆ™æ·»åŠ å®ƒ
                 if (!noMatchP) {
                    const p = document.createElement('p');
                    p.id = 'no-match-message';
                    p.innerText = "æ²¡æœ‰åŒ¹é…çš„è®°å½•ã€‚";
                    resultsDiv.appendChild(p);
                 }
                 return;
            }
            
            // å¦‚æœæœ‰åŒ¹é…ç»“æœï¼Œç§»é™¤â€œæ²¡æœ‰åŒ¹é…çš„è®°å½•â€æ¶ˆæ¯
            if (noMatchP) noMatchP.remove();

            renderTable(filteredResults);
        }

        // ç‹¬ç«‹çš„è¡¨æ ¼æ¸²æŸ“å‡½æ•°
        function renderTable(results) {
            const resultsDiv = document.getElementById('results');
            const oldTable = document.getElementById('resultsTable');
            if (oldTable) oldTable.remove();

            if (results.length === 0) {
                return; // è¿™ç§æƒ…å†µç”± applyFilters å¤„ç†
            }

            let html = `<table id="resultsTable">
                            <thead>
                                <tr>
                                    <th>åŸŸå</th>
                                    <th>çŠ¶æ€/ç±»å‹</th>
                                    <th>è®°å½•å€¼/é”™è¯¯ä¿¡æ¯</th>
                                    <th>å¯¹åº”å‚å•†</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            results.forEach(record => {
                const statusClass = `status-${record.status.split(':')[0].toUpperCase()}`;
                
                html += `
                    <tr>
                        <td>${record.domain}</td>
                        <td class="${statusClass}">${record.type} (${record.status})</td>
                        <td>${record.value}</td>
                        <td>${record.vendor || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            
            // å°†æ–°è¡¨æ ¼è¿½åŠ åˆ° resultsDiv çš„æœ«å°¾
            resultsDiv.innerHTML += html;
        }
        
        // --- 1. å®æ—¶æŸ¥è¯¢é€»è¾‘ ---
        document.getElementById('queryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const domains = document.getElementById('domains').value;
            const dnsServersInput = document.getElementById('dnsServers');
            const dnsServers = dnsServersInput.value;
            const loadingDiv = document.getElementById('loading');
            
            localStorage.setItem(DNS_SERVERS_KEY, dnsServers);
            
            loadingDiv.style.display = 'block';
            document.getElementById('results').innerHTML = ''; // æ¸…ç©ºç»“æœ
            document.getElementById('exportButton').disabled = true; // ç¦ç”¨å¯¼å‡º

            const payload = { domains: domains, dns_servers: dnsServers };

            submitForm('/query', payload, 'queryButton', 'queryStatusMessage', (data) => {
                loadingDiv.style.display = 'none';
                
                LAST_QUERY_RESULTS = data.results; 
                // è®¾ç½®æŸ¥è¯¢ç»“æœçš„å®¹å™¨å†…å®¹ï¼ŒåŒ…æ‹¬æ ‡é¢˜å’Œè€—æ—¶
                document.getElementById('results').innerHTML = `<h2>æŸ¥è¯¢ç»“æœ (${data.results.length} æ¡è®°å½•)</h2>
                                                               <p>æ€»è€—æ—¶: ${data.time_taken}</p>`;
                applyFilters(); // è‡ªåŠ¨åº”ç”¨ç­›é€‰å¹¶æ¸²æŸ“è¡¨æ ¼ï¼Œå¯ç”¨å¯¼å‡ºæŒ‰é’®
            });
        });


        // --- ç­›é€‰å™¨äº‹ä»¶ç»‘å®š (ä¿æŒä¸å˜) ---
        document.getElementById('filterDomain').addEventListener('input', applyFilters);
        document.getElementById('filterVendor').addEventListener('input', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
    </script>
</body>
</html>